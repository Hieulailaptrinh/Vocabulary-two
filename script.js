const vocabularyData = [
  {
    id: 1,
    word: "insert",
    ipa: "/…™nÀàs…úÀêt/",
    meaning: "ch√®n",
    example: "Please insert your card into the slot.",
  },
  {
    id: 2,
    word: "arrange",
    ipa: "/…ôÀàre…™nd í/",
    meaning: "s·∫Øp x·∫øp",
    example: "I will arrange a meeting for tomorrow.",
  },
  {
    id: 3,
    word: "discard",
    ipa: "/d…™Ààsk…ëÀêd/",
    meaning: "v·ª©t, b·ªè",
    example: "Discard any old cleaning materials.",
  },
  {
    id: 4,
    word: "empty",
    ipa: "/Ààemp.ti/",
    meaning: "tr·ªëng, l√†m tr·ªëng",
    example: "The room was entirely empty.",
  },
  {
    id: 5,
    word: "scatter",
    ipa: "/Ààsk√¶t.…ôr/",
    meaning: "ph√¢n t√°n, v·ª©t r·∫£i r√°c",
    example: "The wind scattered the leaves.",
  },
  {
    id: 6,
    word: "canopy",
    ipa: "/Ààk√¶n.…ô.pi/",
    meaning: "m√°i che",
    example: "Trees form a canopy over the road.",
  },
  {
    id: 7,
    word: "display",
    ipa: "/d…™Ààsple…™/",
    meaning: "tr∆∞ng b√†y, tr√¨nh chi·∫øu",
    example: "The goods were displayed in the window.",
  },
  {
    id: 8,
    word: "budget",
    ipa: "/Ààb åd í.…™t/",
    meaning: "ng√¢n s√°ch",
    example: "We are working on a tight budget.",
  },
  {
    id: 9,
    word: "main branch",
    ipa: "/me…™n br…ëÀênt É/",
    meaning: "chi nh√°nh ch√≠nh",
    example: "Please visit our main branch for support.",
  },
  {
    id: 10,
    word: "appointment",
    ipa: "/…ôÀàp…î…™nt.m…ônt/",
    meaning: "cu·ªôc h·∫πn",
    example: "I have a dental appointment at 3 PM.",
  },
  {
    id: 11,
    word: "stop by",
    ipa: "/st…íp ba…™/",
    meaning: "gh√© ngang",
    example: "Can you stop by the store on your way home?",
  },
  {
    id: 12,
    word: "make it",
    ipa: "/me…™k …™t/",
    meaning: "l√†m ƒë∆∞·ª£c (th√†nh c√¥ng/ƒë·∫øn n∆°i)",
    example: "I hope you can make it to the party.",
  },
  {
    id: 13,
    word: "fill the position",
    ipa: "/f…™l √∞…ô p…ôÀàz…™ É.…ôn/",
    meaning: "tuy·ªÉn ng∆∞·ªùi l·∫•p v√†o v·ªã tr√≠",
    example: "We need to fill the position urgently.",
  },
  {
    id: 14,
    word: "innovative",
    ipa: "/Àà…™n.…ô.v…ô.t…™v/",
    meaning: "c√≥ t√≠nh ƒë·ªïi m·ªõi",
    example: "He has many innovative ideas.",
  },
  {
    id: 15,
    word: "feature",
    ipa: "/ÀàfiÀê.t É…ôr/",
    meaning: "ƒë·∫∑c ƒëi·ªÉm, t√≠nh nƒÉng",
    example: "This phone has a unique feature.",
  },
  {
    id: 16,
    word: "revise",
    ipa: "/r…™Ààva…™z/",
    meaning: "s·ª≠a ƒë·ªïi, √¥n t·∫≠p",
    example: "Please revise your essay.",
  },
  {
    id: 17,
    word: "warranty",
    ipa: "/Ààw…ír.…ôn.ti/",
    meaning: "b·∫£o h√†nh",
    example: "The car comes with a 3-year warranty.",
  },
  {
    id: 18,
    word: "property",
    ipa: "/Ààpr…íp.…ô.ti/",
    meaning: "t√†i s·∫£n, b·∫•t ƒë·ªông s·∫£n",
    example: "This property is for sale.",
  },
  {
    id: 19,
    word: "confirmation",
    ipa: "/Àåk…ín.f…ôÀàme…™. É…ôn/",
    meaning: "s·ª± x√°c nh·∫≠n",
    example: "I received a confirmation email.",
  },
  {
    id: 20,
    word: "avoid",
    ipa: "/…ôÀàv…î…™d/",
    meaning: "tr√°nh",
    example: "Try to avoid rush hour traffic.",
  },
  {
    id: 21,
    word: "electrical failure",
    ipa: "/iÀàlek.tr…™.k…ôl Ààfe…™.lj…ôr/",
    meaning: "s·ª± m·∫•t ƒëi·ªán/h·ªèng ƒëi·ªán",
    example: "The blackout was caused by an electrical failure.",
  },
  {
    id: 22,
    word: "occur",
    ipa: "/…ôÀàk…úÀêr/",
    meaning: "x·∫£y ra",
    example: "When did the accident occur?",
  },
  {
    id: 23,
    word: "unavailable",
    ipa: "/Àå ån.…ôÀàve…™.l…ô.b…ôl/",
    meaning: "kh√¥ng c√≥ s·∫µn",
    example: "The manager is currently unavailable.",
  },
  {
    id: 24,
    word: "incorrect",
    ipa: "/Àå…™n.k…ôrÀàekt/",
    meaning: "kh√¥ng ch√≠nh x√°c",
    example: "Your answer is incorrect.",
  },
  {
    id: 25,
    word: "absolutely",
    ipa: "/Àå√¶b.s…ôÀàluÀêt.li/",
    meaning: "m·ªôt c√°ch ch·∫Øc ch·∫Øn",
    example: "You are absolutely right.",
  },
  {
    id: 26,
    word: "acquire",
    ipa: "/…ôÀàkwa…™…ôr/",
    meaning: "ƒë·∫°t ƒë∆∞·ª£c, th√¢u t√≥m",
    example: "The company acquired a new branch.",
  },
  {
    id: 27,
    word: "significant",
    ipa: "/s…™…°Ààn…™f.…™.k…ônt/",
    meaning: "ƒë√°ng k·ªÉ",
    example: "There was a significant change in profits.",
  },
  {
    id: 28,
    word: "restoration",
    ipa: "/Àåres.t…ôrÀàe…™. É…ôn/",
    meaning: "s·ª± kh√¥i ph·ª•c",
    example: "The restoration of the old building is complete.",
  },
  {
    id: 29,
    word: "stunning",
    ipa: "/Ààst ån.…™≈ã/",
    meaning: "tuy·ªát ƒë·∫πp",
    example: "The view from the top is stunning.",
  },
  {
    id: 30,
    word: "unveil",
    ipa: "/ ånÀàve…™l/",
    meaning: "ti·∫øt l·ªô, v√©n m√†n",
    example: "They will unveil the new statue tomorrow.",
  },
  {
    id: 31,
    word: "anniversary",
    ipa: "/Àå√¶n.…™Ààv…úÀê.s…ôr.i/",
    meaning: "ng√†y k·ª∑ ni·ªám",
    example: "It is their 10th wedding anniversary.",
  },
  {
    id: 32,
    word: "informal",
    ipa: "/…™nÀàf…îÀê.m…ôl/",
    meaning: "kh√¥ng trang tr·ªçng",
    example: "The meeting was very informal.",
  },
  {
    id: 33,
    word: "pharmaceutical",
    ipa: "/Àåf…ëÀê.m…ôÀàsuÀê.t…™.k…ôl/",
    meaning: "thu·ªôc d∆∞·ª£c ph·∫©m",
    example: "She works in the pharmaceutical industry.",
  },
  {
    id: 34,
    word: "manufacturer",
    ipa: "/Àåm√¶n.j…ôÀàf√¶k.t É…ôr.…ôr/",
    meaning: "nh√† s·∫£n xu·∫•t",
    example: "Check with the manufacturer for details.",
  },
  {
    id: 35,
    word: "mandatory",
    ipa: "/Ààm√¶n.d…ô.t…ôr.i/",
    meaning: "b·∫Øt bu·ªôc",
    example: "Wearing a helmet is mandatory.",
  },
  {
    id: 36,
    word: "entire",
    ipa: "/…™nÀàta…™…ôr/",
    meaning: "to√†n b·ªô",
    example: "I spent the entire day reading.",
  },
  {
    id: 37,
    word: "funding",
    ipa: "/Ààf ån.d…™≈ã/",
    meaning: "ti·ªÅn t√†i tr·ª£",
    example: "The project received government funding.",
  },
  {
    id: 38,
    word: "extend",
    ipa: "/…™kÀàstend/",
    meaning: "k√©o d√†i, gia h·∫°n",
    example: "Can you extend the deadline?",
  },
  {
    id: 39,
    word: "assistance",
    ipa: "/…ôÀàs…™s.t…ôns/",
    meaning: "s·ª± h·ªó tr·ª£",
    example: "Do you need any assistance?",
  },
  {
    id: 40,
    word: "apply for",
    ipa: "/…ôÀàpla…™ f…îÀêr/",
    meaning: "·ª©ng tuy·ªÉn",
    example: "I decided to apply for the job.",
  },
  {
    id: 41,
    word: "grant",
    ipa: "/…°r…ëÀênt/",
    meaning: "tr·ª£ c·∫•p (n), c·∫•p cho (v)",
    example: "He received a research grant.",
  },
  {
    id: 42,
    word: "segment",
    ipa: "/Ààse…°.m…ônt/",
    meaning: "ph√¢n kh√∫c, ƒëo·∫°n",
    example: "We target a specific market segment.",
  },
  {
    id: 43,
    word: "state of the art",
    ipa: "/Àåste…™t.…ôv.√∞iÀêÀà…ëÀêt/",
    meaning: "hi·ªán ƒë·∫°i nh·∫•t",
    example: "The lab has state-of-the-art technology.",
  },
  {
    id: 44,
    word: "athlete",
    ipa: "/Àà√¶Œ∏.liÀêt/",
    meaning: "v·∫≠n ƒë·ªông vi√™n",
    example: "He is a professional athlete.",
  },
  {
    id: 45,
    word: "compete",
    ipa: "/k…ômÀàpiÀêt/",
    meaning: "c·∫°nh tranh, thi ƒë·∫•u",
    example: "Teams will compete for the gold medal.",
  },
  {
    id: 46,
    word: "delighted",
    ipa: "/d…™Ààla…™.t…™d/",
    meaning: "h√†i l√≤ng, vui v·∫ª",
    example: "I am delighted to meet you.",
  },
  {
    id: 47,
    word: "institute",
    ipa: "/Àà…™n.st…™.t ÉuÀêt/",
    meaning: "vi·ªán, h·ªçc vi·ªán",
    example: "She studies at the Art Institute.",
  },
  {
    id: 48,
    word: "initiative",
    ipa: "/…™Ààn…™ É.…ô.t…™v/",
    meaning: "s√°ng ki·∫øn",
    example: "This is a new peace initiative.",
  },
  {
    id: 49,
    word: "preserve",
    ipa: "/pr…™Ààz…úÀêv/",
    meaning: "g√¨n gi·ªØ, b·∫£o qu·∫£n",
    example: "We must preserve our traditions.",
  },
  {
    id: 50,
    word: "allocate",
    ipa: "/Àà√¶l.…ô.ke…™t/",
    meaning: "ph√¢n b·ªï",
    example: "Funds were allocated for education.",
  },
  {
    id: 51,
    word: "preliminary",
    ipa: "/pr…™Ààl…™m.…™.n…ôr.i/",
    meaning: "s∆° b·ªô",
    example: "These are preliminary results.",
  },
  {
    id: 52,
    word: "findings",
    ipa: "/Ààfa…™n.d…™≈ãz/",
    meaning: "ph√°t hi·ªán, k·∫øt qu·∫£ t√¨m ƒë∆∞·ª£c",
    example: "The findings of the study were published.",
  },
  {
    id: 53,
    word: "forecasting",
    ipa: "/Ààf…îÀêk…ëÀêst…™≈ã/",
    meaning: "d·ª± b√°o",
    example: "Weather forecasting is difficult.",
  },
  {
    id: 54,
    word: "customize",
    ipa: "/Ààk ås.t…ô.ma…™z/",
    meaning: "t√πy ch·ªânh",
    example: "You can customize the settings.",
  },
  {
    id: 55,
    word: "transplant",
    ipa: "/tr√¶nÀàspl…ëÀênt/",
    meaning: "c·∫•y gh√©p",
    example: "He needs a kidney transplant.",
  },
  {
    id: 56,
    word: "variety",
    ipa: "/v…ôÀàra…™.…ô.ti/",
    meaning: "s·ª± ƒëa d·∫°ng, nhi·ªÅu lo·∫°i",
    example: "The store offers a variety of goods.",
  },
  {
    id: 57,
    word: "resident",
    ipa: "/Ààrez.…™.d…ônt/",
    meaning: "c∆∞ d√¢n",
    example: "She is a resident of this city.",
  },
  {
    id: 58,
    word: "promotion",
    ipa: "/pr…ôÀàm…ô ä. É…ôn/",
    meaning: "s·ª± thƒÉng ch·ª©c, qu·∫£ng b√°",
    example: "He got a promotion at work.",
  },
  {
    id: 59,
    word: "fill out",
    ipa: "/f…™l a ät/",
    meaning: "ƒëi·ªÅn v√†o (ƒë∆°n)",
    example: "Please fill out this form.",
  },
  {
    id: 60,
    word: "receipt",
    ipa: "/r…™ÀàsiÀêt/",
    meaning: "bi√™n lai",
    example: "Keep your receipt for proof of purchase.",
  },
  {
    id: 61,
    word: "engage",
    ipa: "/…™nÀà…°e…™d í/",
    meaning: "tham gia, thu√™, ƒë√≠nh h√¥n",
    example: "We need to engage the audience.",
  },
  {
    id: 62,
    word: "reside",
    ipa: "/r…™Ààza…™d/",
    meaning: "c∆∞ tr√∫",
    example: "He resides in London.",
  },
  {
    id: 63,
    word: "stimulation",
    ipa: "/Àåst…™m.j…ôÀàle…™. É…ôn/",
    meaning: "s·ª± k√≠ch th√≠ch",
    example: "The brain needs mental stimulation.",
  },
  {
    id: 64,
    word: "representative",
    ipa: "/Àårep.r…™Ààzen.t…ô.t…™v/",
    meaning: "ng∆∞·ªùi ƒë·∫°i di·ªán",
    example: "Contact our customer representative.",
  },
  {
    id: 65,
    word: "permission",
    ipa: "/p…ôÀàm…™ É.…ôn/",
    meaning: "s·ª± cho ph√©p",
    example: "You need permission to enter.",
  },
  {
    id: 66,
    word: "certified",
    ipa: "/Ààs…úÀê.t…™.fa…™d/",
    meaning: "ƒë∆∞·ª£c ch·ª©ng nh·∫≠n",
    example: "She is a certified accountant.",
  },
  {
    id: 67,
    word: "determine",
    ipa: "/d…™Ààt…úÀê.m…™n/",
    meaning: "x√°c ƒë·ªãnh, quy·∫øt ƒë·ªãnh",
    example: "We need to determine the cause.",
  },
  {
    id: 68,
    word: "upcoming",
    ipa: "/Àà åpÀåk åm.…™≈ã/",
    meaning: "s·∫Øp t·ªõi",
    example: "We are preparing for the upcoming event.",
  },
  {
    id: 69,
    word: "dependable",
    ipa: "/d…™Ààpen.d…ô.b…ôl/",
    meaning: "ƒë√°ng tin c·∫≠y",
    example: "He is a very dependable friend.",
  },
  {
    id: 70,
    word: "reminder",
    ipa: "/r…™Ààma…™n.d…ôr/",
    meaning: "l·ªùi nh·∫Øc",
    example: "This is a reminder about the meeting.",
  },
  {
    id: 71,
    word: "surrounding",
    ipa: "/s…ôÀàra än.d…™≈ã/",
    meaning: "xung quanh, bao quanh",
    example: "The surrounding area is beautiful.",
  },
  {
    id: 72,
    word: "opposition",
    ipa: "/Àå…íp.…ôÀàz…™ É.…ôn/",
    meaning: "s·ª± ph·∫£n ƒë·ªëi, phe ƒë·ªëi l·∫≠p",
    example: "There was strong opposition to the plan.",
  },
  {
    id: 73,
    word: "adjust",
    ipa: "/…ôÀàd í åst/",
    meaning: "ƒëi·ªÅu ch·ªânh",
    example: "Adjust the volume if it is too loud.",
  },
  {
    id: 74,
    word: "durable",
    ipa: "/Ààd í ä…ô.r…ô.b…ôl/",
    meaning: "b·ªÅn",
    example: "This fabric is very durable.",
  },
  {
    id: 75,
    word: "rave review",
    ipa: "/re…™v r…™ÀàvjuÀê/",
    meaning: "ƒë√°nh gi√° khen ng·ª£i h·∫øt l·ªùi",
    example: "The movie received rave reviews.",
  },
  {
    id: 76,
    word: "nutrition",
    ipa: "/njuÀêÀàtr…™ É.…ôn/",
    meaning: "dinh d∆∞·ª°ng",
    example: "Good nutrition is essential for health.",
  },
  {
    id: 77,
    word: "justify",
    ipa: "/Ààd í ås.t…™.fa…™/",
    meaning: "bi·ªán minh",
    example: "You cannot justify such behavior.",
  },
  {
    id: 78,
    word: "criticise",
    ipa: "/Ààkr…™t.…™.sa…™z/",
    meaning: "ch·ªâ tr√≠ch",
    example: "Don't criticise what you don't understand.",
  },
  {
    id: 79,
    word: "inconvenience",
    ipa: "/Àå…™n.k…ônÀàviÀê.ni.…ôns/",
    meaning: "s·ª± b·∫•t ti·ªán",
    example: "We apologize for the inconvenience.",
  },
  {
    id: 80,
    word: "anticipate",
    ipa: "/√¶nÀàt…™s.…™.pe…™t/",
    meaning: "d·ª± ƒëo√°n, mong ƒë·ª£i",
    example: "We anticipate a large crowd.",
  },
];

// --- QU·∫¢N L√ù TR·∫†NG TH√ÅI (STATE) ---
let currentVocabList = [...vocabularyData];
let learnedIds = JSON.parse(localStorage.getItem("learnedWords")) || [];
let currentIndex = 0; // Index Flashcard

// Bi·∫øn cho ph·∫ßn Practice Quiz
let quizIndex = 0;
let wrongAnswers = [];
let isReviewMode = false;

// Bi·∫øn cho ph·∫ßn Context Quiz
let contextIndex = 0;

// --- DOM ELEMENTS ---
// Navigation
const navItems = document.querySelectorAll("nav ul li");
const sections = document.querySelectorAll(".section");

// Flashcard
const flashcard = document.getElementById("flashcard");
const elWord = document.getElementById("vocab-word");
const elIpa = document.getElementById("vocab-ipa");
const elMeaning = document.getElementById("vocab-meaning");
const elExample = document.getElementById("vocab-example");
const elCounter = document.getElementById("card-counter");
const btnSpeak = document.getElementById("btn-speak");
const btnNext = document.getElementById("btn-next");
const btnPrev = document.getElementById("btn-prev");
const btnShuffle = document.getElementById("btn-shuffle");
const btnMarkLearned = document.getElementById("btn-mark-learned");
const inputJump = document.getElementById("jump-input");
const btnJump = document.getElementById("btn-jump");

// Practice Quiz
const quizWordEl = document.getElementById("quiz-word");
const quizOptionsEl = document.getElementById("quiz-options");
const quizFeedbackEl = document.getElementById("quiz-feedback");
const btnNextQuiz = document.getElementById("btn-next-quiz");
const wrongCountEl = document.getElementById("wrong-count");
const btnReviewMistakes = document.getElementById("btn-review-mistakes");
const quizModeLabel = document.getElementById("quiz-mode-label");

// Context Quiz (ƒêI·ªÄN T·ª™) - C·∫¨P NH·∫¨T BI·∫æN
const contextSentenceEl = document.getElementById("context-sentence");
const contextOptionsEl = document.getElementById("context-options");
const contextFeedbackEl = document.getElementById("context-feedback");
const contextCounterEl = document.getElementById("context-counter");
const btnNextContextAuto = document.getElementById("btn-next-context-auto");
const btnRestartContext = document.getElementById("btn-restart-context");
// C√°c n√∫t m·ªõi th√™m
const btnContextPrev = document.getElementById("btn-context-prev");
const btnContextNext = document.getElementById("btn-context-next");

// Progress
const progressPercentEl = document.getElementById("progress-percent");
const learnedCountEl = document.getElementById("learned-count");
const totalCountEl = document.getElementById("total-count");
const btnViewLearned = document.getElementById("btn-view-learned");
const learnedListBox = document.getElementById("learned-list-container");
const learnedListContent = document.getElementById("learned-list-content");
const btnCloseList = document.getElementById("btn-close-list");
const btnReset = document.getElementById("btn-reset");
const circularProgress = document.querySelector(".circular-progress");

// --- KH·ªûI T·∫†O ---
window.addEventListener("DOMContentLoaded", () => {
  loadFlashcard(currentIndex);
  updateProgressUI();

  // Kh·ªüi t·∫°o c√°c b√†i t·∫≠p
  loadPracticeQuiz();
  loadContextQuiz();
});

// --- CH·ª®C NƒÇNG 1: NAVIGATION (CHUY·ªÇN TAB) ---
navItems.forEach((item) => {
  item.addEventListener("click", () => {
    navItems.forEach((nav) => nav.classList.remove("active"));
    item.classList.add("active");

    const targetId = item.getAttribute("data-target");
    sections.forEach((sec) => sec.classList.remove("active-section"));
    document.getElementById(targetId).classList.add("active-section");

    if (targetId === "home") window.scrollTo(0, 0);
    // N·∫øu chuy·ªÉn sang tab writing th√¨ load l·∫°i ƒë·ªÉ ƒë·∫£m b·∫£o c·∫≠p nh·∫≠t
    if (targetId === "writing") loadContextQuiz();
  });
});

window.navigateTo = (targetId) => {
  document.querySelector(`nav ul li[data-target="${targetId}"]`).click();
};

// --- CH·ª®C NƒÇNG 2: FLASHCARD ---
function loadFlashcard(index) {
  const data = currentVocabList[index];
  flashcard.classList.remove("flipped");
  elWord.textContent = data.word;
  elIpa.textContent = data.ipa;
  elMeaning.textContent = data.meaning;
  elExample.textContent = `"${data.example}"`;
  elCounter.textContent = `${index + 1}/${currentVocabList.length}`;

  if (learnedIds.includes(data.id)) {
    btnMarkLearned.textContent = "üéâ ƒê√£ thu·ªôc t·ª´ n√†y";
    btnMarkLearned.disabled = true;
    btnMarkLearned.classList.replace("btn-success", "btn-secondary");
  } else {
    btnMarkLearned.textContent = "‚úÖ ƒê√£ thu·ªôc t·ª´ n√†y";
    btnMarkLearned.disabled = false;
    btnMarkLearned.classList.replace("btn-secondary", "btn-success");
  }
}

flashcard.addEventListener("click", () => {
  flashcard.classList.toggle("flipped");
});

btnSpeak.addEventListener("click", (e) => {
  e.stopPropagation();
  const utterance = new SpeechSynthesisUtterance(
    currentVocabList[currentIndex].word
  );
  utterance.lang = "en-US";
  window.speechSynthesis.speak(utterance);
});

btnNext.addEventListener("click", () => {
  if (currentIndex < currentVocabList.length - 1) {
    currentIndex++;
    loadFlashcard(currentIndex);
  } else {
    currentIndex = 0;
    loadFlashcard(currentIndex);
  }
});

btnPrev.addEventListener("click", () => {
  if (currentIndex > 0) {
    currentIndex--;
    loadFlashcard(currentIndex);
  } else {
    currentIndex = currentVocabList.length - 1;
    loadFlashcard(currentIndex);
  }
});

btnJump.addEventListener("click", () => {
  const val = parseInt(inputJump.value);
  if (val >= 1 && val <= currentVocabList.length) {
    currentIndex = val - 1;
    loadFlashcard(currentIndex);
    inputJump.value = "";
  } else {
    alert(`Vui l√≤ng nh·∫≠p s·ªë t·ª´ 1 ƒë·∫øn ${currentVocabList.length}`);
  }
});

btnShuffle.addEventListener("click", () => {
  for (let i = currentVocabList.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [currentVocabList[i], currentVocabList[j]] = [
      currentVocabList[j],
      currentVocabList[i],
    ];
  }
  currentIndex = 0;
  loadFlashcard(currentIndex);

  const originalText = btnShuffle.innerHTML;
  btnShuffle.innerHTML = "ƒê√£ tr·ªôn!";
  setTimeout(() => (btnShuffle.innerHTML = originalText), 1000);
});

btnMarkLearned.addEventListener("click", (e) => {
  e.stopPropagation();
  const currentItem = currentVocabList[currentIndex];
  if (!learnedIds.includes(currentItem.id)) {
    learnedIds.push(currentItem.id);
    localStorage.setItem("learnedWords", JSON.stringify(learnedIds));
    updateProgressUI();
    loadFlashcard(currentIndex);
  }
});

// --- CH·ª®C NƒÇNG 3: PRACTICE QUIZ ---
function loadPracticeQuiz() {
  quizFeedbackEl.textContent = "";
  quizOptionsEl.innerHTML = "";
  btnNextQuiz.style.display = "none";

  let sourceList = isReviewMode ? wrongAnswers : vocabularyData;
  if (isReviewMode && wrongAnswers.length === 0) {
    isReviewMode = false;
    quizModeLabel.style.display = "none";
    alert("B·∫°n ƒë√£ ho√†n th√†nh c√°c c√¢u sai!");
    loadPracticeQuiz();
    return;
  }

  if (quizIndex >= sourceList.length) quizIndex = 0;

  const questionData = sourceList[quizIndex];
  quizWordEl.textContent = questionData.word;

  let options = [questionData];
  while (options.length < 4) {
    const randomItem =
      vocabularyData[Math.floor(Math.random() * vocabularyData.length)];
    if (!options.some((o) => o.id === randomItem.id)) options.push(randomItem);
  }
  options.sort(() => Math.random() - 0.5);

  options.forEach((opt) => {
    const btn = document.createElement("button");
    btn.className = "option-btn";
    btn.textContent = opt.meaning;
    btn.onclick = () => checkQuizAnswer(opt, questionData, btn);
    quizOptionsEl.appendChild(btn);
  });
}

function checkQuizAnswer(selected, correct, btnElement) {
  const allBtns = quizOptionsEl.querySelectorAll(".option-btn");
  allBtns.forEach((b) => (b.disabled = true));

  if (selected.id === correct.id) {
    btnElement.classList.add("correct");
    quizFeedbackEl.textContent = "Ch√≠nh x√°c! üéâ";
    quizFeedbackEl.style.color = "var(--success)";

    if (isReviewMode) {
      wrongAnswers = wrongAnswers.filter((w) => w.id !== correct.id);
      updateWrongCount();
    }
  } else {
    btnElement.classList.add("wrong");
    quizFeedbackEl.textContent = `Sai r·ªìi! ƒê√°p √°n l√†: ${correct.meaning}`;
    quizFeedbackEl.style.color = "var(--error)";
    allBtns.forEach((b) => {
      if (b.textContent === correct.meaning) b.classList.add("correct");
    });
    if (!wrongAnswers.some((w) => w.id === correct.id)) {
      wrongAnswers.push(correct);
      updateWrongCount();
    }
  }
  btnNextQuiz.style.display = "inline-block";
}

btnNextQuiz.addEventListener("click", () => {
  if (!isReviewMode) {
    quizIndex = Math.floor(Math.random() * vocabularyData.length);
  } else {
    quizIndex = 0;
  }
  loadPracticeQuiz();
});

function updateWrongCount() {
  wrongCountEl.textContent = wrongAnswers.length;
  btnReviewMistakes.disabled = wrongAnswers.length === 0;
}

btnReviewMistakes.addEventListener("click", () => {
  isReviewMode = true;
  quizModeLabel.style.display = "inline-block";
  quizIndex = 0;
  loadPracticeQuiz();
});

// --- CH·ª®C NƒÇNG 4: CONTEXT QUIZ (ƒêI·ªÄN T·ª™) ---
function loadContextQuiz() {
  // Reset UI
  contextFeedbackEl.textContent = "";
  contextOptionsEl.innerHTML = "";
  btnNextContextAuto.style.display = "none";
  btnRestartContext.style.display = "none";
  contextSentenceEl.style.display = "block";

  // 1. Logic n√∫t ƒëi·ªÅu h∆∞·ªõng (C·∫¨P NH·∫¨T)
  // Kh√≥a n√∫t Previous n·∫øu ·ªü c√¢u ƒë·∫ßu
  btnContextPrev.disabled = contextIndex === 0;
  // Kh√≥a n√∫t Next n·∫øu ·ªü c√¢u cu·ªëi
  btnContextNext.disabled = contextIndex === vocabularyData.length - 1;

  // 2. Ki·ªÉm tra ho√†n th√†nh (n·∫øu ƒëi qu√° s·ªë l∆∞·ª£ng)
  if (contextIndex >= vocabularyData.length) {
    contextSentenceEl.innerHTML = "üéâ B·∫°n ƒë√£ ho√†n th√†nh h·∫øt danh s√°ch.";
    contextCounterEl.textContent = `${vocabularyData.length}/${vocabularyData.length}`;
    btnRestartContext.style.display = "inline-block";
    return;
  }

  const data = vocabularyData[contextIndex];
  contextCounterEl.textContent = `${contextIndex + 1}/${vocabularyData.length}`;

  // Regex thay th·∫ø t·ª´
  const regex = new RegExp(`\\b${data.word}\\b`, "gi");
  if (!data.example.match(regex)) {
    // N·∫øu c√¢u l·ªói kh√¥ng t√¨m th·∫•y t·ª´, t·ª± ƒë·ªông next
    console.log("Skipping sentence due to mismatch:", data.word);
    if (contextIndex < vocabularyData.length - 1) {
      contextIndex++;
      loadContextQuiz();
    }
    return;
  }

  const hiddenSentence = data.example.replace(
    regex,
    `<span class="blank-highlight">_____</span>`
  );
  contextSentenceEl.innerHTML = hiddenSentence;

  // T·∫°o ƒë√°p √°n
  let options = [data];
  while (options.length < 4) {
    const randomItem =
      vocabularyData[Math.floor(Math.random() * vocabularyData.length)];
    if (!options.some((o) => o.id === randomItem.id)) options.push(randomItem);
  }
  options.sort(() => Math.random() - 0.5);

  options.forEach((opt) => {
    const btn = document.createElement("button");
    btn.className = "option-btn";
    btn.textContent = opt.word;
    btn.onclick = () => checkContextAnswer(opt.id, data.id, data.word, btn);
    contextOptionsEl.appendChild(btn);
  });
}

function checkContextAnswer(selectedId, correctId, correctWord, btnElement) {
  const allBtns = contextOptionsEl.querySelectorAll(".option-btn");
  allBtns.forEach((b) => (b.disabled = true));

  if (selectedId === correctId) {
    btnElement.classList.add("correct");
    contextFeedbackEl.textContent = "Ch√≠nh x√°c!";
    contextFeedbackEl.style.color = "var(--success)";

    // ƒêi·ªÅn t·ª´ v√†o ch·ªó tr·ªëng
    const blank = contextSentenceEl.querySelector(".blank-highlight");
    if (blank) {
      blank.textContent = correctWord;
      blank.classList.add("filled");
    }

    // Hi·ªán n√∫t Next (n·∫øu mu·ªën next th·ªß c√¥ng)
    if (contextIndex < vocabularyData.length - 1) {
      btnNextContextAuto.style.display = "inline-block";
    }
  } else {
    btnElement.classList.add("wrong");
    contextFeedbackEl.textContent = `Sai r·ªìi! ƒê√°p √°n l√†: ${correctWord}`;
    contextFeedbackEl.style.color = "var(--error)";
    allBtns.forEach((b) => {
      if (b.textContent === correctWord) b.classList.add("correct");
    });
  }
}

// Event Listeners cho Context
btnNextContextAuto.addEventListener("click", () => {
  if (contextIndex < vocabularyData.length - 1) {
    contextIndex++;
    loadContextQuiz();
  }
});

btnRestartContext.addEventListener("click", () => {
  contextIndex = 0;
  loadContextQuiz();
});

// --- S·ª∞ KI·ªÜN M·ªöI CHO N√öT ƒêI·ªÄU H∆Ø·ªöNG CONTEXT ---
btnContextPrev.addEventListener("click", () => {
  if (contextIndex > 0) {
    contextIndex--;
    loadContextQuiz();
  }
});

btnContextNext.addEventListener("click", () => {
  if (contextIndex < vocabularyData.length - 1) {
    contextIndex++;
    loadContextQuiz();
  }
});

// --- CH·ª®C NƒÇNG 5: PROGRESS ---
function updateProgressUI() {
  const learnedCount = learnedIds.length;
  const total = vocabularyData.length;
  learnedCountEl.textContent = learnedCount;
  totalCountEl.textContent = total;

  const percent = Math.round((learnedCount / total) * 100);
  progressPercentEl.textContent = `${percent}%`;

  circularProgress.style.background = `conic-gradient(
    var(--success) ${percent * 3.6}deg,
    #cadcff ${percent * 3.6}deg
  )`;
}

btnViewLearned.addEventListener("click", () => {
  learnedListContent.innerHTML = "";
  if (learnedIds.length === 0) {
    learnedListContent.innerHTML =
      "<p style='padding:10px; text-align:center'>Ch∆∞a c√≥ t·ª´ n√†o.</p>";
  } else {
    learnedIds.forEach((id) => {
      const item = vocabularyData.find((v) => v.id === id);
      if (item) {
        const li = document.createElement("li");
        li.className = "learned-item";
        li.innerHTML = `
          <span class="learned-word">${item.word}</span>
          <span class="learned-meaning">${item.meaning}</span>
        `;
        learnedListContent.appendChild(li);
      }
    });
  }
  learnedListBox.style.display = "block";
});

btnCloseList.addEventListener("click", () => {
  learnedListBox.style.display = "none";
});

btnReset.addEventListener("click", () => {
  if (confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a to√†n b·ªô ti·∫øn ƒë·ªô?")) {
    learnedIds = [];
    localStorage.removeItem("learnedWords");
    updateProgressUI();
    loadFlashcard(currentIndex);
    alert("ƒê√£ reset!");
  }
});
